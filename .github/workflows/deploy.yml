# .github/workflows/deploy.yml

name: Deploy to Oracle Cloud

# 이 워크플로우가 언제 실행될지 정의합니다.
# main 브랜치에 push 이벤트가 발생했을 때 실행됩니다.
on:
  push:
    branches: [ main ]

# 실행될 작업들을 정의합니다.
jobs:
  deploy:
    # 이 작업이 실행될 가상 환경을 지정합니다.
    runs-on: ubuntu-latest

    # 실행될 단계들을 순서대로 정의합니다.
    steps:
    # 1. 먼저, GitHub 저장소의 코드를 가상 환경으로 가져옵니다(checkout).
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. SSH를 통해 원격 서버에 접속하여 배포 스크립트를 실행합니다.
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.OCI_SSH_HOST }}      # GitHub Secret에서 서버 IP를 가져옴
        username: ${{ secrets.OCI_SSH_USER }}  # GitHub Secret에서 사용자 이름을 가져옴
        key: ${{ secrets.OCI_SSH_PRIVATE_KEY }} # GitHub Secret에서 SSH 비공개 키를 가져옴
        script: |
          # --- 이 아래부터는 오라클 클라우드 서버에서 실행될 명령어들입니다 ---
          cd ~/memora  # 실제 프로젝트 폴더 경로로 수정하세요!
          git pull origin main
          npm install --production # 새로운 의존성 설치 (프로덕션용)
          npx knex migrate:latest
          pm2 reload my-app      # PM2로 실행 중인 앱을 무중단 재시작