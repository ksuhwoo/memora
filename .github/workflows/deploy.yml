# .github/workflows/deploy.yml

name: Deploy to Oracle Cloud

# ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì •ì˜í•©ë‹ˆë‹¤.
# main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
on:
  push:
    branches: [ master ]

# ì‹¤í–‰ë  ì‘ì—…ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  deploy:
    # ì´ ì‘ì—…ì´ ì‹¤í–‰ë  ê°€ìƒ í™˜ê²½ì„ ì§€ì •í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # ì‹¤í–‰ë  ë‹¨ê³„ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì •ì˜í•©ë‹ˆë‹¤.
    steps:
    # 1. ë¨¼ì €, GitHub ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤(checkout).
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. SSHë¥¼ í†µí•´ ì›ê²© ì„œë²„ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.OCI_SSH_HOST }}
        username: ${{ secrets.OCI_SSH_USER }}
        key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
        # ğŸ’¡ğŸ’¡ğŸ’¡ ë°”ë¡œ ì´ script ë¶€ë¶„ì„ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤ ğŸ’¡ğŸ’¡ğŸ’¡
        script: |
          # 1. ë¨¼ì €, í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
          cd ~/memora  # â€¼ï¸ ì‹¤ì œ í”„ë¡œì íŠ¸ í´ë” ê²½ë¡œë¡œ ìˆ˜ì •í•˜ì„¸ìš”!

          # 2. git pullì˜ ë¸Œëœì¹˜ ì´ë¦„ì„ 'master'ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤. (ë³¸ì¸ ë¸Œëœì¹˜ì— ë§ê²Œ)
          git pull origin master

          # 3. â€¼ï¸ ì—¬ê¸°ê°€ í•µì‹¬! nvmì„ ìˆ˜ë™ìœ¼ë¡œ ë¡œë“œí•˜ì—¬ npm, npx ê²½ë¡œë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤.
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          # 4. ì´ì œ npm, npx, pm2ë¥¼ ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          npm install --production
          npx knex migrate:latest
          pm2 reload my-app