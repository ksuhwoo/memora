# .github/workflows/deploy.yml

name: Deploy to Oracle Cloud

# 이 워크플로우가 언제 실행될지 정의합니다.
# main 브랜치에 push 이벤트가 발생했을 때 실행됩니다.
on:
  push:
    branches: [ master ]

# 실행될 작업들을 정의합니다.
jobs:
  deploy:
    # 이 작업이 실행될 가상 환경을 지정합니다.
    runs-on: ubuntu-latest

    # 실행될 단계들을 순서대로 정의합니다.
    steps:
    # 1. 먼저, GitHub 저장소의 코드를 가상 환경으로 가져옵니다(checkout).
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. SSH를 통해 원격 서버에 접속하여 배포 스크립트를 실행합니다.
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.OCI_SSH_HOST }}
        username: ${{ secrets.OCI_SSH_USER }}
        key: ${{ secrets.OCI_SSH_PRIVATE_KEY }}
        # 💡💡💡 바로 이 script 부분을 아래 내용으로 교체합니다 💡💡💡
        script: |
          # 1. 먼저, 프로젝트 폴더로 이동합니다.
          cd ~/memora  # ‼️ 실제 프로젝트 폴더 경로로 수정하세요!

          # 2. git pull의 브랜치 이름을 'master'로 수정합니다. (본인 브랜치에 맞게)
          git pull origin master

          # 3. ‼️ 여기가 핵심! nvm을 수동으로 로드하여 npm, npx 경로를 알려줍니다.
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          # 4. 이제 npm, npx, pm2를 모두 사용할 수 있습니다.
          npm install --production
          npx knex migrate:latest
          pm2 reload my-app